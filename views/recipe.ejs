<!-- views/recipe.ejs -->
<%- include('partials/header') %>

<!-- Category Navigation Bar -->
<div class="mb-4">
  <nav class="nav nav-pills">
    <a class="nav-link <%= currentCategory === 'all' ? 'active' : '' %>" href="/?category=all">All</a>
    <a class="nav-link <%= currentCategory === 'breakfast' ? 'active' : '' %>" href="/?category=breakfast">Breakfast</a>
    <a class="nav-link <%= currentCategory === 'lunch' ? 'active' : '' %>" href="/?category=lunch">Lunch</a>
    <a class="nav-link <%= currentCategory === 'dinner' ? 'active' : '' %>" href="/?category=dinner">Dinner</a>
    <a class="nav-link <%= currentCategory === 'dessert' ? 'active' : '' %>" href="/?category=dessert">Dessert</a>
  </nav>
</div>

<div class="container mt-4">
  <div class="card mb-4">
    <% if (recipe.photo && /^https?:\/\//.test(recipe.photo)) { %>
      <img src="<%= recipe.photo %>" class="card-img-top" alt="Recipe Image">
    <% } else if (recipe.photo) { %>
      <img src="data:image/jpeg;base64,<%= recipe.photo %>" class="card-img-top" alt="Recipe Image">
    <% } else { %>
      <img src="https://cdn.glitch.global/40caaa32-7609-49ce-895e-9832535559ab/FOOD.jpg?v=1734423437576" class="card-img-top" alt="Default Recipe Image">
    <% } %>
    <div class="card-body">
      <!-- Recipe Description -->
      <h3 class="card-title"><%= recipe.description %></h3>

      <!-- Ingredients -->
      <h5>Ingredients</h5>
      <ul>
        <% recipe.ingredient.forEach(item => { %>
          <li><%= item %></li>
        <% }) %>
      </ul>

      <!-- Instructions -->
      <h5>Instructions</h5>
      <p><%= recipe.instruction %></p>

      <!-- Likes Display -->
      <p>Likes: <span id="like-count"><%= recipe.likes || 0 %></span></p>

      <!-- Like Button -->
      <% if (user) { %>
        <% if (hasLiked) { %>
          <button id="unlike-btn" class="btn btn-danger">Unlike</button>
        <% } else { %>
          <button id="like-btn" class="btn btn-primary">Like</button>
        <% } %>
      <% } else { %>
        <p><a href="/users/login">Log in</a> to like this recipe.</p>
      <% } %>
    </div>
  </div>

  <!-- Author Information -->
  <% if (creator) { %>
    <div class="mb-4">
      <h5>Recipe Created By:</h5>
      <p><%= creator.first_name %> <%= creator.last_name %></p>
    </div>
  <% } %>

  <!-- Comments Section -->
  <div class="comments-section">
    <h4>Comments</h4>
    <p>Comment functionality can be added here.</p>
  </div>
</div>

<%- include('partials/footer') %>

<!-- Like Button Script -->
<script>
  <% if (user) { %>
    <% if (hasLiked) { %>
      // User has already liked: show "Unlike" functionality
      document.getElementById('unlike-btn').addEventListener('click', async () => {
        try {
          const response = await fetch('/recipes/unlike/<%= recipe._id %>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.success) {
            document.getElementById('like-count').innerText = data.likes;
            // Switch button back to Like
            const unlikeBtn = document.getElementById('unlike-btn');
            unlikeBtn.outerHTML = `<button id="like-btn" class="btn btn-primary">Like</button>`;

            document.getElementById('like-btn').addEventListener('click', async () => {
              try {
                const likeResponse = await fetch('/recipes/like/<%= recipe._id %>', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                });

                const likeData = await likeResponse.json();

                if (likeData.success) {
                  document.getElementById('like-count').innerText = likeData.likes;
                  document.getElementById('like-btn').innerText = 'Liked';
                  document.getElementById('like-btn').classList.remove('btn-primary');
                  document.getElementById('like-btn').classList.add('btn-danger');
                  document.getElementById('like-btn').id = 'unlike-btn';
                } else {
                  alert(likeData.message || 'Cannot like this recipe.');
                }
              } catch (error) {
                console.error('Error : ', error);
                alert('Error when liking a recipe. Please log in.');
              }
            });
          } else {
            alert(data.message || 'Cannot unlike this recipe.');
          }
        } catch (error) {
          console.error('Error: ', error);
          alert('Error when unliking a recipe. Please log in.');
        }
      });
    <% } else { %>
      // User has not liked: show "Like" functionality
      document.getElementById('like-btn').addEventListener('click', async () => {
        try {
          const response = await fetch('/recipes/like/<%= recipe._id %>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.success) {
            document.getElementById('like-count').innerText = data.likes;
            // Switch button to Unlike
            const likeBtn = document.getElementById('like-btn');
            likeBtn.outerHTML = `<button id="unlike-btn" class="btn btn-danger">Unlike</button>`;

            document.getElementById('unlike-btn').addEventListener('click', async () => {
              try {
                const unlikeResponse = await fetch('/recipes/unlike/<%= recipe._id %>', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                });

                const unlikeData = await unlikeResponse.json();

                if (unlikeData.success) {
                  document.getElementById('like-count').innerText = unlikeData.likes;
                  document.getElementById('unlike-btn').innerText = 'Like';
                  document.getElementById('unlike-btn').classList.remove('btn-danger');
                  document.getElementById('unlike-btn').classList.add('btn-primary');
                  document.getElementById('unlike-btn').id = 'like-btn';
                } else {
                  alert(unlikeData.message || 'Cannot unlike this recipe.');
                }
              } catch (error) {
                console.error('Error: ', error);
                alert('Error when unliking a recipe. Please log in.');
              }
            });
          } else {
            alert(data.message || 'Cannot like this recipe.');
          }
        } catch (error) {
          console.error('Error: ', error);
          alert('Error when liking a recipe. Please log in.');
        }
      });
    <% } %>
  <% } %>
</script>
