<!-- views/recipe.ejs -->
<%- include('partials/header') %>

<!-- Category Navigation Bar -->
<div class="mb-4">
  <nav class="nav nav-pills">
    <a class="nav-link <%= currentCategory === 'all' ? 'active' : '' %>" href="/?category=all">All</a>
    <a class="nav-link <%= currentCategory === 'breakfast' ? 'active' : '' %>" href="/?category=breakfast">Breakfast</a>
    <a class="nav-link <%= currentCategory === 'lunch' ? 'active' : '' %>" href="/?category=lunch">Lunch</a>
    <a class="nav-link <%= currentCategory === 'dinner' ? 'active' : '' %>" href="/?category=dinner">Dinner</a>
    <a class="nav-link <%= currentCategory === 'dessert' ? 'active' : '' %>" href="/?category=dessert">Dessert</a>
  </nav>
</div>

<div class="container mt-4">
  <div class="card mb-4">
    <% if (recipe.photo && /^https?:\/\//.test(recipe.photo)) { %>
      <img src="<%= recipe.photo %>" class="card-img-top" alt="Recipe Image">
    <% } else if (recipe.photo) { %>
      <img src="data:image/jpeg;base64,<%= recipe.photo %>" class="card-img-top" alt="Recipe Image">
    <% } else { %>
      <img src="/images/default-recipe.png" class="card-img-top" alt="Default Recipe Image">
    <% } %>
    <div class="card-body">
      <!-- Recipe Description -->
      <h3 class="card-title"><%= recipe.description %></h3>

      <!-- Ingredients -->
      <h5>Ingredients</h5>
      <ul>
        <% recipe.ingredient.forEach(item => { %>
          <li><%= item %></li>
        <% }) %>
      </ul>

      <!-- Instructions -->
      <h5>Instructions</h5>
      <p><%= recipe.instruction %></p>

      <!-- Likes Display -->
      <p>Likes: <span id="like-count"><%= recipe.likes || 0 %></span></p>

      <!-- Like Button -->
      <button id="like-btn" class="btn btn-primary" <%= user && user.likedRecipes.includes(recipe._id) ? 'disabled' : '' %>>
        <%= user && user.likedRecipes.includes(recipe._id) ? 'Liked' : 'Like' %>
      </button>
    </div>
  </div>

  <!-- Author Information -->
  <% if (creator) { %>
    <div class="mb-4">
      <h5>Recipe Created By:</h5>
      <p><%= creator.first_name %> <%= creator.last_name %></p>
    </div>
  <% } %>

  <!-- Comments Section -->
  <div class="comments-section">
    <h4>Comments</h4>
    <p>Comment functionality can be added here.</p>
  </div>
</div>

<%- include('partials/footer') %>

<!-- Like Button Script -->
<script>
  document.getElementById('like-btn').addEventListener('click', async () => {
    try {
      // Send like request
      const response = await fetch('/recipes/like/<%= recipe._id %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();

      if (data.success) {
        // Update like count
        document.getElementById('like-count').innerText = data.likes;
        document.getElementById('like-btn').innerText = 'Liked';
        document.getElementById('like-btn').disabled = true;
      } else {
        alert(data.message || 'Unable to like this recipe.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while liking the recipe.');
    }
  });
</script>
